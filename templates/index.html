<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Done and Dusted</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0a0a0a; --card: #161616; --cyan: #00f2ff; --purple: #bc13fe; --high: #ff4d4d; }
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: white; margin: 0; overflow-x: hidden; transition: 0.5s; }
        .main-wrapper { display: flex; width: 100vw; transition: transform 0.5s ease; }
        .content-area { flex: 1; padding: 40px; max-width: 900px; margin: auto; transition: 0.5s; }
        
        /* THE SHIFT LOGIC */
        .layout-shrunk { transform: translateX(-175px); }
        .fab-shrunk { transform: translateX(-350px); } /* Moves the button left when panel opens */

        .header { text-align: center; margin-bottom: 30px; }
        .logo { width: 200px; filter: drop-shadow(0 0 10px rgba(0, 242, 255, 0.2)); }

        .toolbar { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; margin-bottom: 30px; }
        .t-input { background: #1a1a1a; border: 1px solid #333; color: white; padding: 12px; border-radius: 10px; outline: none; font-family: inherit; }
        
        .btn-history { background: var(--purple); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; position: relative; }
        .badge { position: absolute; top: -8px; right: -8px; background: var(--cyan); color: black; border-radius: 50%; width: 22px; height: 22px; font-size: 11px; display: flex; align-items: center; justify-content: center; border: 2px solid var(--bg); font-weight: 800; }

        .task-card { background: var(--card); border-radius: 18px; padding: 22px; margin-bottom: 18px; border: 1px solid #222; display: flex; justify-content: space-between; align-items: center; transition: 0.3s; }
        .is-urgent { border: 1px solid var(--high); box-shadow: 0 0 15px rgba(255, 77, 77, 0.15); }
        
        .task-info { flex: 1; padding-right: 20px; }
        .urgent-tag { color: var(--high); font-size: 11px; font-weight: 800; margin-bottom: 5px; display: block; }

        .task-actions { display: flex; align-items: center; gap: 20px; }
        .cb-wrapper { cursor: pointer; width: 28px; height: 28px; position: relative; }
        .cb-wrapper input { opacity: 0; width: 0; height: 0; }
        .checkmark { position: absolute; top: 0; left: 0; height: 28px; width: 28px; background: #222; border-radius: 8px; border: 2px solid var(--cyan); }
        .cb-wrapper input:checked ~ .checkmark { background: var(--cyan); }
        .cb-wrapper input:checked ~ .checkmark:after { content: "✓"; position: absolute; left: 7px; top: 2px; color: black; font-weight: 900; font-size: 18px; }
        .btn-del { color: #444; text-decoration: none; font-size: 32px; transition: 0.2s; line-height: 1; }
        .btn-del:hover { color: var(--high); }

        #historyPanel { position: fixed; right: -350px; top: 0; width: 350px; height: 100%; background: #0d0d0d; border-left: 1px solid var(--purple); padding: 30px; transition: 0.5s ease; z-index: 100; box-sizing: border-box; overflow-y: auto; }
        .history-open { right: 0 !important; }

        .modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); align-items: center; justify-content: center; }
        .modal-content { background: var(--card); padding: 35px; border-radius: 24px; width: 420px; border: 1px solid #333; }
        
        /* FIXED PLUS BUTTON WITH TRANSITION */
        .fab { position: fixed; bottom: 35px; right: 35px; width: 65px; height: 65px; background: var(--cyan); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 35px; color: black; cursor: pointer; border: none; z-index: 150; box-shadow: 0 0 20px rgba(0, 242, 255, 0.3); transition: transform 0.5s cubic-bezier(0.77, 0, 0.175, 1); }

        .empty-state { border: 2px dashed #222; padding: 80px; text-align: center; border-radius: 25px; cursor: pointer; color: #444; }
        #noMatchMsg { text-align: center; padding: 40px; color: #444; display: none; }
    </style>
</head>
<body>

    <button class="fab" id="mainFab" onclick="openModal()">+</button>

    <div class="main-wrapper" id="mainWrapper">
        <div class="content-area">
            <div class="header">
                <img src="{{ url_for('static', filename='logo.png') }}" class="logo">
            </div>

            <div class="toolbar">
                <input type="text" id="liveSearch" class="t-input" placeholder="Live search tasks..." onkeyup="liveLogic()">
                
                <select id="liveSort" class="t-input" onchange="liveLogic()">
                    <option value="date">Sort: Newest</option>
                    <option value="priority">Sort: Priority</option>
                    <option value="alphabet">Sort: A-Z</option>
                    <option value="due">Sort: Due Date</option>
                </select>

                <button class="btn-history" onclick="toggleHistory()">
                    History
                    {% if count > 0 %}<span class="badge">{{ count }}</span>{% endif %}
                </button>
            </div>

            <div id="taskList">
                <div id="noMatchMsg">No tasks match your search...</div>
                {% if tasks|length < 1 %}
                    <div class="empty-state" onclick="openModal()">
                        <h3>No tasks at hand!</h3>
                        <p>Click + to start.</p>
                    </div>
                {% endif %}

                {% for task in tasks %}
                <div class="task-card {{ 'is-urgent' if task.is_urgent }}" 
                     data-title="{{ task.title.lower() }}" 
                     data-priority="{{ task.priority }}" 
                     data-date="{{ task.date_created }}"
                     data-due="{{ task.due_date if task.due_date else '9999-12-31' }}">
                    
                    <div class="task-info">
                        {% if task.is_urgent %}
                            <span class="urgent-tag">⚠ DUE IN {{ task.days_left }} DAYS</span>
                        {% endif %}
                        <h3 style="margin: 0 0 5px 0;">{{ task.title }}</h3>
                        <p style="color: #888; margin: 0 0 10px 0;">{{ task.description }}</p>
                        {% if task.due_date %}
                            <small style="color: var(--cyan); font-weight: 600;">Do By: {{ task.due_date.strftime('%Y-%m-%d') }}</small>
                        {% endif %}
                    </div>

                    <div class="task-actions">
                        <label class="cb-wrapper">
                            <input type="checkbox" onchange="setTimeout(() => { window.location.href='/complete/{{task.id}}' }, 350)">
                            <span class="checkmark"></span>
                        </label>
                        <a href="/delete/{{task.id}}" class="btn-del">&times;</a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div id="historyPanel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="color:var(--purple); margin:0;">History</h2>
            <button onclick="toggleHistory()" style="background:none; border:none; color:white; font-size:30px; cursor:pointer;">&times;</button>
        </div>
        <p style="color:#555; font-size:13px; margin: 10px 0;">Total Tasks: {{ count }}</p>
        <a href="/clear_history" style="color:var(--high); font-size:12px; text-decoration:none; font-weight:800;">CLEAR ALL HISTORY</a>
        
        <div style="margin-top:30px;">
            {% for task in history %}
            <div style="opacity:0.4; border-bottom:1px solid #222; padding:15px 0;">
                <div style="text-decoration: line-through; font-weight: 600;">{{ task.title }}</div>
                <small>Done on: {{ task.date_created.strftime('%b %d') }}</small>
            </div>
            {% endfor %}
        </div>
    </div>

    <div id="taskModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-top: 0; margin-bottom: 25px;">New Task</h2>
            <form action="/" method="POST">
                <label style="color:var(--cyan); font-size:12px; font-weight:bold;">TITLE</label>
                <input type="text" name="title" class="t-input" style="width:100%; margin-bottom:15px;" required>
                
                <label style="color:var(--cyan); font-size:12px; font-weight:bold;">DESCRIPTION</label>
                <textarea name="description" class="t-input" style="width:100%; margin-bottom:15px; height:80px;"></textarea>
                
                <div style="display:flex; gap:15px;">
                    <div style="flex:1">
                        <label style="color:var(--cyan); font-size:12px; font-weight:bold;">PRIORITY</label>
                        <select name="priority" class="t-input" style="width:100%">
                            <option value="Low">Low</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>
                    <div style="flex:1">
                        <label style="color:var(--cyan); font-size:12px; font-weight:bold;">DO BY:</label>
                        <input type="date" name="due_date" class="t-input" style="width:100%">
                    </div>
                </div>

                <button type="submit" style="background:var(--cyan); width:100%; padding:15px; border:none; border-radius:12px; font-weight:800; cursor:pointer; margin-top:20px;">ADD TASK</button>
            </form>
        </div>
    </div>

    <script>
        // LOAD PREFERENCE ON STARTUP
        window.onload = function() {
            if (localStorage.getItem('historyOpen') === 'true') {
                applyHistoryToggle(true);
            }
        };

        function toggleHistory() {
            const isOpen = document.getElementById('historyPanel').classList.contains('history-open');
            applyHistoryToggle(!isOpen);
            localStorage.setItem('historyOpen', !isOpen);
        }

        function applyHistoryToggle(shouldOpen) {
            const panel = document.getElementById('historyPanel');
            const wrapper = document.getElementById('mainWrapper');
            const fab = document.getElementById('mainFab');
            
            if (shouldOpen) {
                panel.classList.add('history-open');
                wrapper.classList.add('layout-shrunk');
                fab.classList.add('fab-shrunk');
            } else {
                panel.classList.remove('history-open');
                wrapper.classList.remove('layout-shrunk');
                fab.classList.remove('fab-shrunk');
            }
        }

        function openModal() { document.getElementById('taskModal').style.display='flex'; }
        window.onclick = function(e) { if(e.target.className == 'modal') document.getElementById('taskModal').style.display='none'; }

        function liveLogic() {
            const search = document.getElementById('liveSearch').value.toLowerCase();
            const sort = document.getElementById('liveSort').value;
            const container = document.getElementById('taskList');
            const tasks = Array.from(container.getElementsByClassName('task-card'));
            let visibleCount = 0;

            tasks.forEach(t => {
                const text = t.getAttribute('data-title');
                const isMatch = text.includes(search);
                t.style.display = isMatch ? "flex" : "none";
                if(isMatch) visibleCount++;
            });

            document.getElementById('noMatchMsg').style.display = (visibleCount === 0 && search !== "") ? "block" : "none";

            tasks.sort((a, b) => {
                if(sort === 'alphabet') return a.getAttribute('data-title').localeCompare(b.getAttribute('data-title'));
                if(sort === 'priority') {
                    const map = {High:1, Medium:2, Low:3};
                    return map[a.getAttribute('data-priority')] - map[b.getAttribute('data-priority')];
                }
                if(sort === 'due') return a.getAttribute('data-due').localeCompare(b.getAttribute('data-due'));
                return b.getAttribute('data-date').localeCompare(a.getAttribute('data-date'));
            });
            tasks.forEach(t => container.appendChild(t));
        }
    </script>
</body>
</html>